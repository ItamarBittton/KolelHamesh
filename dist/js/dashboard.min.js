angular.module('RDash', ['ui.bootstrap', 'ui.router', 'ngCookies', 'ui-notification'])
    .config(function (NotificationProvider) {
        NotificationProvider.setOptions({
            startTop: 20,
            startRight: 10,
            verticalSpacing: 20,
            horizontalSpacing: 20,
            positionX: 'left',
            positionY: 'bottom'
        });
    });;
'use strict';

/**
 * Route configuration for the RDash module.
 */
angular.module('RDash').config(['$stateProvider', '$urlRouterProvider',
    function($stateProvider, $urlRouterProvider) {

        // For unmatched routes
        $urlRouterProvider.otherwise('/');

        // Application routes
        $stateProvider
            .state('index', {
                url: '/',
                templateUrl: 'templates/dashboard.html'
            })
            .state('tables', {
                url: '/tables',
                templateUrl: 'templates/tables.html'
            })
            .state('students', {
                url: '/students',
                templateUrl: 'templates/students.html',
                controller: 'studentController'
            })
            .state('recomends', {
                url: '/recomends',
                templateUrl: 'templates/recomends.html',
                controller: 'recomendController'
            })
            .state('daily', {
                url: '/daily',
                templateUrl: 'templates/daily.html',
                controller: 'dailyController'
            });
    }
]);
/**
 * Alerts Controller
 */

angular
    .module('RDash')
    .controller('AlertsCtrl', ['$scope', AlertsCtrl]);

function AlertsCtrl($scope) {
    $scope.alerts = [{
        type: 'success',
        msg: 'Thanks for visiting! Feel free to create pull requests to improve the dashboard!'
    }, {
        type: 'danger',
        msg: 'Found a bug? Create an issue with as many details as you can.'
    }];

    $scope.addAlert = function() {
        $scope.alerts.push({
            msg: 'Another alert!'
        });
    };

    $scope.closeAlert = function(index) {
        $scope.alerts.splice(index, 1);
    };
}
angular.module('RDash').controller("dailyController", function ($scope, Data) {
    $scope.disable = false;
    $scope.definition = [];
    $scope.show = function (date) {
        if (date) {

            $scope.disable = true;
            

            Data.get('daily').then(function (data) {
               $scope.students = data;
               $scope.definition = ['בזמן', 'מאחר']
            })

            var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
             for (var j = 0; j < 3; j++) {
                 var texta = "";
                 var textb = "";
                 var textc = "";
                 for (var i = 0; i < 5; i++) {
                     texta += possible.charAt(Math.floor(Math.random() * possible.length));
                     textb += possible.charAt(Math.floor(Math.random() * possible.length));
                     textc += possible.charAt(Math.floor(Math.random() * possible.length));

                 }
                 $scope.students[j] = {
                     first: texta,
                     last: textb,
                     phone: textc
                 }
                 $scope.definition[j] = texta + textb;
             }
        }
    }
    
    $scope.students = [{first : 'אני', last : 'ואתה', phone : 'נשנה'}];
    $scope.viewDate = {
        year: new Date().getFullYear(),
        month: new Date().getMonth() + 1
    }
});
/**
 * Master Controller
 */

angular.module('RDash')
    .controller('MasterCtrl', function MasterCtrl($scope, $cookies, $rootScope, translate) {
        /**
         * Sidebar Toggle & Cookie Control
         */
        var mobileView = 992;

        $scope.getWidth = function () {
            return window.innerWidth;
        };

        $scope.logout = function () {
            document.cookie = 'token=; Max-Age=0; link=; Max-Age=0;';
            window.location.href = '/';
        }

        $scope.$watch($scope.getWidth, function (newValue, oldValue) {
            if (newValue >= mobileView) {
                if (angular.isDefined($cookies.get('toggle'))) {
                    $scope.toggle = !$cookies.get('toggle') ? false : true;
                } else {
                    $scope.toggle = true;
                }
            } else {
                $scope.toggle = false;
            }

        });

        $scope.toggleSidebar = function () {
            $scope.toggle = !$scope.toggle;
            $cookies.put('toggle', $scope.toggle);
        };

        $scope.role = $cookies.get('link');
        $rootScope.t = translate;

        window.onresize = function () {
            $scope.$apply();
        };
    });
angular.module('RDash')
    .controller('recomendController', function ($scope, Data, $rootScope) {
        Data.get('recomends').then(function (data) {
            $scope.recomends = data.recomends;
        })

        $scope.recomend = {};

        $scope.add = function () {
            $scope.display = true;
        };

        $scope.edit = function (id) {
            $scope.display = true;
            $scope.recomend = $scope.recomends[id];
            $scope.editId = id.toString();
        }

        $scope.save = function (valid) {
            if (!valid) {
                $scope.formErrors = true;
            } else if (valid) {
                var method = $scope.recomend.editId ? 'put' : 'post';

                Data[method]('recomends', { id: $scope.recomend.editId, student: $scope.recomend }).then(function (result) {
                    $scope.recomends = data.recomends;
                });

                $scope.close();
            }
        }

        $scope.close = function () {
            $scope.recomend = {};
            $scope.formErrors = false;
            $scope.display = false;
        }

        $scope.action = function (index, action) {
            Data.post(action, { editId: $scope.editId, data: $scope.recomends[index] }).then(function (data) {
                if (data.recomends) $scope.recomends = data.recomends;
                $scope.editId = undefined;
            });
        };
    });
angular.module('RDash')
    .controller('studentController', function ($scope, Data) {
        Data.get('students').then(function (data) {
            $scope.students = data.students;
        })

        $scope.student = {};

        $scope.add = function () {
            $scope.display = true;
        };

        $scope.edit = function (id) {
            $scope.display = true;
            $scope.student = $scope.students[id];
            $scope.student.editId = id.toString();
        }

        $scope.save = function (valid) {
            if (!valid) {
                $scope.formErrors = true;
            } else if (valid) {                
                Data.post('recomends', { data: $scope.student, table: 'students' }).then(function (result) {
                    $scope.students = result.data;
                });

                // Data[method]('students', { id: $scope.student.editId, student: $scope.student }).then(function (result) {
                //     $scope.students = data.students;
                // });

                $scope.close();
            }
        }

        $scope.close = function () {
            $scope.student = {};
            $scope.formErrors = false;
            $scope.display = false;
        }
    });
/**
 * Loading Directive
 * @see http://tobiasahlin.com/spinkit/
 */

angular
    .module('RDash')
    .directive('rdLoading', rdLoading);

function rdLoading() {
    var directive = {
        restrict: 'AE',
        template: '<div class="spinner">' +
                     '<div class="bounce1"></div>' +
                     '<div class="bounce2"></div>' +
                     '<div class="bounce3"></div>' +
                  '</div>'
    };
    return directive;
};
angular
    .module('RDash').directive("myCalendar", function () {
        return {
            scope: {
                viewDate: "=",
                show: "&"
            },
            template: `<div class="board">
                           <div class="square" ng-repeat='day in month' ng-click="show({date : day.gerg})">
                               <div class="date">{{day.val}}</div>
                           </div>
                       </div>`,
            link: function (scope) {
                var month = scope.viewDate.month,
                    year = scope.viewDate.year,
                    range = new Date(year, month - 1, 0).getDate(),
                    start = new Date(year, month - 1, 1).getDay();

                scope.month = [];
                for (var i = 0; i < 35; i++) {
                    if (i < start || i > range) {
                        scope.month.push({
                            key: i
                        });
                    } else {
                        var today = new Date(year, month - 1, i + 1),
                            HebDate = new Hebcal.HDate(new Date(today)).toString('h').split(' ').slice(0, 2).join(' ');
                        scope.month.push({
                            key: i,
                            val: HebDate,
                            gerg: today
                        });
                    }
                }
            }
        }
    });
angular
    .module('RDash').directive("studentList", function () {
        return {
            scope: {
                students: "=",
                definition: "="
            },
            template: `<div>
		<table class="table" >
            <thead style="text-align: center">
              <td colspan="4" class="lborder">פרטי האברך</td>
			  <td colspan="3" class="lborder">נוכחות</td>
			  </thead>
			  <thead>
				<td>שם פרטי</td>
				<td>שם משפחה</td>
				<td>טלפון</td>
			  </thead>
			  <tbody>
				<tr ng-repeat="student in students.dailyRep">
					<td >{{student.first}}</td>
					<td >{{student.last}}</td>
					<td >{{student.phone}}</td>
					<td >
						<select class="form-control">
							<option ng-repeat="def in definition" val={{def}}>{{def}}</option>
						</select>
					</td>
				</tr>
			  </tbody>
			  </table>
		</div>`,
            link: function (scope) {
				
            }

        }
    })
/**
 * Widget Body Directive
 */

angular
    .module('RDash')
    .directive('rdWidgetBody', rdWidgetBody);

function rdWidgetBody() {
    var directive = {
        requires: '^rdWidget',
        scope: {
            loading: '=?',
            classes: '@?'
        },
        transclude: true,
        template: '<div class="widget-body" ng-class="classes"><rd-loading ng-show="loading"></rd-loading><div ng-hide="loading" class="widget-content" ng-transclude></div></div>',
        restrict: 'E'
    };
    return directive;
};

/**
 * Widget Footer Directive
 */

angular
    .module('RDash')
    .directive('rdWidgetFooter', rdWidgetFooter);

function rdWidgetFooter() {
    var directive = {
        requires: '^rdWidget',
        transclude: true,
        template: '<div class="widget-footer" ng-transclude></div>',
        restrict: 'E'
    };
    return directive;
};
/**
 * Widget Header Directive
 */

angular
    .module('RDash')
    .directive('rdWidgetHeader', rdWidgetTitle);

function rdWidgetTitle() {
    var directive = {
        requires: '^rdWidget',
        scope: {
            title: '@',
            icon: '@'
        },
        transclude: true,
        template: '<div class="widget-header"><div class="row"><div class="pull-right"><i class="fa" ng-class="icon"></i> {{title}} </div><div class="pull-left col-xs-6 col-sm-4" ng-transclude></div></div></div>',
        restrict: 'E'
    };
    return directive;
};
/**
 * Widget Directive
 */

angular
    .module('RDash')
    .directive('rdWidget', rdWidget);

function rdWidget() {
    var directive = {
        transclude: true,
        template: '<div class="widget" ng-transclude></div>',
        restrict: 'EA'
    };
    return directive;

    function link(scope, element, attrs) {
        /* */
    }
};
// This service connects to our REST API
angular.module('RDash').factory("Data", function ($http, Notification) {

    var serviceBase = '/';

    var obj = {};
    var alertMessage = function (data) {
        if (data.success) Notification.success(data.success);
        if (data.error) Notification.error(data.error);
    }
    obj.get = function (q, external) {
        var path = external ? q : serviceBase + q;
        return $http.get(path).then(function (results) {
            alertMessage(results.data);
            return results.data;
        });
    };
    obj.post = function (q, object) {
        return $http.post(serviceBase + q, object).then(function (results) {
            alertMessage(results.data);
            return results.data;
        });
    };
    obj.put = function (q, object) {
        return $http.put(serviceBase + q, object).then(function (results) {
            alertMessage(results.data);
            return results.data;
        });
    };
    obj.delete = function (q) {
        return $http.delete(serviceBase + q).then(function (results) {
            alertMessage(results.data);
            return results.data;
        });
    };

    return obj;
});
// This service translates keys to hebrew.
angular.module('RDash').constant("translate", {
    "account": "חשבון",
    "accountName": "על שם",
    "bank": "בנק",
    "branch": "סניף",
    "city": "עיר",
    "firstName": "שם פרטי",
    "house": "מס בית",
    "id": "זהות",
    "lastName": "שם משפחה",
    "phone": "טלפון",
    "street": "רחוב",
    "students": "אברך"
});